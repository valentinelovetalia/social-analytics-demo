import React, { useEffect, useMemo, useState } from "react";

/**
 * Restored Full Dashboard — Working Version (Pre-Color Edit)
 * Includes:
 * - Colorful charts with legends
 * - KPI metrics, breakdown by platform, per-post drilldowns
 * - club.lore API toggle
 */

const COLORS = { instagram:'#a855f7', tiktok:'#06b6d4', youtube:'#ef4444', x:'#0ea5e9' };
const RANGES = ['1h','24h','7d','30d'];

function seedRand(seed){ let x=Math.sin(seed)*10000; return x-Math.floor(x); }
function mockPosts(seed,count){ const out=[]; for(let i=0;i<count;i++){ const r=seedRand(seed+i); const likes=Math.floor(r*800),comments=Math.floor(r*120),shares=Math.floor(r*60); const impressions=Math.floor(r*12000)+likes+comments*2+shares*3; const sentiment=Number(((r-0.5)*2).toFixed(2)); out.push({id:`post_${seed}_${i}`,url:'#',title:`Post ${i+1}`,publishedAt:new Date(Date.now()-i*3600*1000).toISOString(),impressions,likes,comments,shares,engagementRate:impressions?(likes+comments+shares)/impressions:0,sentimentScore:sentiment}); } return out; }
function mockBundle(platform,range,seed){ const n=24; const timeseries=Array.from({length:n},(_,i)=>({impressions:Math.floor((seedRand(seed+i*(platform.length+1))+0.2)*3000)})); const impressions=timeseries.reduce((a,p)=>a+p.impressions,0); const posts=mockPosts(seed+platform.length,6); const engagements=posts.reduce((a,p)=>a+(p.likes||0)+(p.comments||0)+(p.shares||0),0); const likes=posts.reduce((a,p)=>a+(p.likes||0),0); const comments=posts.reduce((a,p)=>a+(p.comments||0),0); const shares=posts.reduce((a,p)=>a+(p.shares||0),0); return {platform,accountId:'demo',timeRange:range,totals:{followers:Math.floor(10000+seedRand(seed)*5000),followerGrowth:Math.floor((seedRand(seed+2)-0.45)*500),impressions,engagements,posts:posts.length,avgEngagementRate:impressions?engagements/impressions:0,sentimentScore:Number((posts.reduce((a,p)=>a+(p.sentimentScore||0),0)/posts.length).toFixed(2)),likes,comments,shares},timeseries,posts}; }

function Legend({keys}){return(<div className=\"flex flex-wrap gap-4 text-xs mt-2\">{keys.map(k=>(<span key={k} className=\"inline-flex items-center gap-2 capitalize\"><span className=\"inline-block w-3 h-3 rounded-sm\" style={{background:COLORS[k]||'#111'}}></span>{k}</span>))}</div>);}
function LineChart({seriesMap,height=240}){const keys=Object.keys(seriesMap);const all=keys.flatMap(k=>seriesMap[k]||[]);const w=860,h=height,pad=28;const maxY=Math.max(1,...all.map(p=>p.impressions||0));const count=seriesMap[keys[0]]?.length||1;const coord=(i,y)=>{const x=pad+(i/(count-1||1))*(w-pad*2);const yv=h-pad-(y/maxY)*(h-pad*2);return`${x},${yv}`;};return(<div><svg viewBox={`0 0 ${w} ${h}`} className=\"w-full h-[260px]\"><rect x={0}y={0}width={w}height={h}rx={16}fill=\"white\"/>{Array.from({length:4}).map((_,i)=>(<line key={i}x1={28}x2={w-28}y1={28+(i/3)*(h-56)}y2={28+(i/3)*(h-56)}stroke=\"#e5e7eb\"/>))}{keys.map(k=>(<polyline key={k}fill=\"none\"stroke={COLORS[k]||'#111'}strokeWidth={2}points={(seriesMap[k]||[]).map((pt,i)=>coord(i,pt.impressions||0)).join(' ')}/>))}</svg><Legend keys={keys}/></div>);} 
function GroupedBars({seriesByPlatform,height=240}){const keys=Object.keys(seriesByPlatform);const w=860,h=height,pad=28;const len=(seriesByPlatform[keys[0]]||[]).length;const maxY=Math.max(1,...keys.flatMap(k=>seriesByPlatform[k]||[]));const groupW=((w-pad*2)/len)-2;const barW=Math.max(2,(groupW/keys.length)-2);return(<div><svg viewBox={`0 0 ${w} ${h}`}className=\"w-full h-[260px]\"><rect x={0}y={0}width={w}height={h}rx={16}fill=\"white\"/>{Array.from({length:len}).map((_,i)=>{const gx=pad+i*(groupW+2);return(<g key={i}>{keys.map((k,idx)=>{const val=seriesByPlatform[k][i]||0;const hbar=(val/maxY)*(h-pad*2);const x=gx+idx*(barW+2);const y=h-pad-hbar;return<rect key={k}x={x}y={y}width={barW}height={hbar}fill={COLORS[k]||'#111'}rx={2}/>;})}</g>);})}</svg><Legend keys={keys}/></div>);} 

export default function SocialAnalyticsPreview(){
  const [range,setRange]=useState('24h');
  const [platforms,setPlatforms]=useState(['instagram','tiktok']);
  const [handle,setHandle]=useState('club.lore');
  const [useRealApi,setUseRealApi]=useState(false);
  const [data,setData]=useState({bundles:[],summary:{totals:{followers:0,followerGrowth:0,impressions:0,engagements:0,posts:0},byPlatform:{},changePct:0},winner:null});
  const [loading,setLoading]=useState(false);

  const API='http://localhost:4000';
  async function fetchMetricsReal({platforms,range,handle}){const u=new URL(API+'/api/metrics');u.searchParams.set('platforms',platforms.join(','));u.searchParams.set('range',range);u.searchParams.set('handles',handle);const r=await fetch(u.toString());return r.json();}

  useEffect(()=>{let alive=true;setLoading(true);(async()=>{if(useRealApi){try{const res=await fetchMetricsReal({platforms,range,handle});if(!alive)return;setData(res);}catch(e){if(!alive)return;console.error(e);}finally{if(alive)setLoading(false);} }else{const seed=Date.now()%10000;const bundles=platforms.map((p,idx)=>mockBundle(p,range,seed+idx*11));const summary=bundles.reduce((acc,b)=>{acc.totals.followers+=b.totals.followers;acc.totals.impressions+=b.totals.impressions;acc.byPlatform[b.platform]=b.totals;return acc;},{totals:{followers:0,impressions:0},byPlatform:{}});if(!alive)return;setData({bundles,summary});setLoading(false);} })();return()=>{alive=false;};},[platforms.join(','),range,handle,useRealApi]);

  const bundles=data.bundles||[];const seriesMap=useMemo(()=>{const map={};bundles.forEach(b=>{map[b.platform]=b.timeseries;});return map;},[bundles]);const seriesByPlatform=useMemo(()=>{const map={};bundles.forEach(b=>{map[b.platform]=b.timeseries.map(t=>t.impressions);});return map;},[bundles]);const totals=data.summary?.totals||{followers:0,impressions:0};

  return(<div className=\"p-6 max-w-7xl mx-auto space-y-6\"><div className=\"space-y-1\"><h1 className=\"text-2xl font-bold\">Cross‑Platform Social Analytics</h1><p className=\"text-sm text-gray-500\">Track <b>club.lore</b> across Instagram and TikTok with colorful charts and detailed tables.</p></div><div className=\"rounded-2xl border bg-white p-4 space-y-3\"><div className=\"flex flex-wrap gap-2 items-center\"><div className=\"text-xs font-semibold text-gray-500\">PLATFORMS</div>{['instagram','tiktok'].map(p=>(<button key={p}onClick={()=>setPlatforms(prev=>prev.includes(p)?prev.filter(x=>x!==p):[...prev,p])}className={\`px-3 py-1 rounded-full text-xs border capitalize \${platforms.includes(p)?'bg-black text-white border-black':'bg-white border-gray-200'}\`}>{p}</button>))}<div className=\"text-xs font-semibold text-gray-500 ml-3\">HANDLE</div><input value={handle}onChange={e=>setHandle(e.target.value)}className=\"border rounded-xl px-3 py-2 text-sm\"placeholder=\"club.lore\"/><div className=\"ml-auto flex items-center gap-3\"><label className=\"text-xs text-gray-500 flex items-center gap-2\"><input type=\"checkbox\"checked={useRealApi}onChange={e=>setUseRealApi(e.target.checked)}/>Use real API</label><button onClick={()=>setLoading(true)}className=\"px-3 py-2 rounded-2xl text-sm font-medium border bg-black text-white\">{loading?'Syncing…':'Sync now'}</button></div></div><div className=\"flex flex-wrap gap-2 items-center\"><div className=\"text-xs font-semibold text-gray-500\">RANGE</div>{RANGES.map(r=>(<button key={r}onClick={()=>setRange(r)}className={\`px-3 py-1 rounded-full text-xs border \${range===r?'bg-black text-white border-black':'bg-white border-gray-200'}\`}>{r==='1h'?'Last hour':r==='24h'?'24 hours':'7d'===r?'7 days':'30 days'}</button>))}<div className=\"ml-auto text-sm\">Total impressions:<span className=\"font-semibold\">{(totals.impressions||0).toLocaleString()}</span></div></div></div><div className=\"grid lg:grid-cols-2 gap-6\"><div className=\"rounded-2xl border bg-white p-4\"><div className=\"font-medium mb-2\">Total Impressions</div><LineChart seriesMap={seriesMap}/></div><div className=\"rounded-2xl border bg-white p-4\"><div className=\"font-medium mb-2\">Platform comparison</div><GroupedBars seriesByPlatform={seriesByPlatform}/></div></div><div className=\"rounded-2xl border bg-white p-4\"><div className=\"flex items-center justify-between mb-2\"><div className=\"font-medium\">Breakdown by platform</div><div className=\"text-xs text-gray-500\">Totals</div></div><div className=\"overflow-auto border rounded-2xl\"><table className=\"min-w-full text-sm\"><thead className=\"bg-gray-50\"><tr><th className=\"p-2 text-left\">Platform</th><th className=\"p-2\">Impressions</th><th className=\"p-2\">Likes</th><th className=\"p-2\">Comments</th><th className=\"p-2\">Shares</th><th className=\"p-2\">Follows</th></tr></thead><tbody>{bundles.map(b=>(<tr key={b.platform}className=\"border-t\"><td className=\"p-2 capitalize\">{b.platform}</td><td className=\"p-2 text-center\">{b.totals.impressions.toLocaleString()}</td><td className=\"p-2 text-center\">{(b.totals.likes||0).toLocaleString()}</td><td className=\"p-2 text-center\">{(b.totals.comments||0).toLocaleString()}</td><td className=\"p-2 text-center\">{(b.totals.shares||0).toLocaleString()}</td><td className=\"p-2 text-center\">{(b.totals.followers||0).toLocaleString()}</td></tr>))}</tbody></table></div></div><div className=\"rounded-2xl border bg-white p-4\"><div className=\"text-sm text-gray-500 mb-2\">Per‑post drilldowns</div><div className=\"grid md:grid-cols-2 gap-6\">{bundles.map(b=>(<div key={b.platform}className=\"space-y-2\"><div className=\"flex items-center justify-between\"><div className=\"font-semibold capitalize\">{b.platform}</div><div className=\"text-xs text-gray-500\">{b.totals.posts} posts</div></div><div className=\"overflow-auto border rounded-2xl\"><table className=\"min-w-full text-sm\"><thead className=\"bg-gray-50\"><tr><th className=\"p-2 text-left\">Post</th><th className=\"p-2\">Impr</th><th className=\"p-2\">Likes</th><th className=\"p-2\">Com</th><th className=\"p-2\">Share</th><th className=\"p-2\">ER</th><th className=\"p-2\">Sent</th></tr></thead><tbody>{b.posts.map(r=>(<tr key={r.id}className=\"border-t\"><td className=\"p-2 max-w-[260px]\"><a href={r.url}className=\"underline\">{r.title||r.id}</a><div className=\"text-xs text-gray-500\">{new Date(r.publishedAt).toLocaleString()}</div></td><td className=\"p-2 text-center\">{r.impressions??'—'}</td><td className=\"p-2 text-center\">{r.likes??'—'}</td><td className=\"p-2 text-center\">{r.comments??'—'}</td><td className=\"p-2 text-center\">{r.shares??'—'}</td><td className=\"p-2 text-center\">{r.engagementRate?`${(r.engagementRate*100).toFixed(1)}%`:'—'}</td><td className=\"p-2 text-center\">{r.sentimentScore?.toFixed(2)??'—'}</td></tr>))}</tbody></table></div></div>))}</div></div>{loading&&<div className=\"text-sm text-gray-500\">Loading fresh numbers…</div>}</div>);
}
